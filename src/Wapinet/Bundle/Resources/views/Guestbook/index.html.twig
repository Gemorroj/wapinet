{% extends '::base.html.twig' %}

{% block title %}Гостевая{% endblock %}
{% block breadcrumbs %}
    {{wapinet_breadcrumbs()}}
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">{% autoescape 'js' %}
        $(document).on("pagecreate", "#page", function () {
            var $pageContainer = $(this);
            var $textarea = $pageContainer.find("#{{ form.children.message.vars.id }}");
            var $form = $pageContainer.find("form[name='{{ form.vars.full_name }}']");
            $form.submit(function () {
                $form.find("#{{ form.children.submit.vars.id }}").attr('disabled', 'disabled');
            });
            var quote = function () {
                $textarea.focus();

                var $liComment = $(this).parent().next();
                var text = $liComment.children('div').text();
                var author = $liComment.find('span.fos_comment_comment_authorname>a').text();
                $textarea.val('[quote=' + author + ']' + text + '[/quote]');
                $textarea.keyup();

                return false;
            };
            var popup = function () {
                var $link = $(this);
                $($link.attr('href')).popup("open", {"transition": "turn", "positionTo": $link});

                return false;
            };

            $pageContainer.find('a[href^="#popup-"]').click(popup);
            $pageContainer.find("a.item-quote").click(quote);
        });
    {% endautoescape %}</script>
{% endblock %}

{% block content %}
    {% for flashMessage in app.session.flashbag.get('notice') %}
        <div>
            {{ flashMessage }}
        </div>
    {% endfor %}

    {{ form_start(form, {'action': path('guestbook_add'), 'method': 'POST'}) }}
        {% include '@Wapinet/bot-checker.html.twig' %}
        {{ form_widget(form) }}
    {{ form_end(form) }}

    <div class="fos_comment_thread">
        <ul data-role="listview" data-inset="true">
            {% for item in pagerfanta %}
                <li data-role="list-divider">
                    <a href="#{{ form.message.vars.id }}" class="item-quote">#</a>
                    {{ item.createdAt|wapinet_datetime }}
                </li>
                <li data-icon="false">
                    <span class="fos_comment_comment_avatar">
                        {% if item.user %}
                            <img src="{{ wapinet_user_get_avatar_url(item.user) }}" alt="{{ item.user }}" class="image-preview" />
                        {% else %}
                            <img src="{{ wapinet_user_get_avatar_url() }}" alt="Anonymous" class="image-preview" />
                        {% endif %}
                        {% if item.user and item.user.isOnline %}
                            <span class="avatar-online"></span>
                        {% endif %}
                    </span>
                    {% block fos_comment_comment_metas_authorline %}
                        <span class="fos_comment_comment_authorname">
                        {% if item.user %}
                            <a class="bar-button ui-btn-icon-left ui-icon-user ui-mini ui-btn-inline ui-btn" href="{{ path('wapinet_user_profile', {'username': item.user.username}) }}">{{ item.user.username }}</a>
                        {% else %}
                            {% set geoip2 = wapinet_geoip2_country(item.ip) %}
                            <a class="bar-button ui-btn-icon-left ui-icon-user ui-mini ui-btn-inline ui-btn no-link" href="#popup-{{ item.id }}">Anonymous</a>
                            <div data-role="popup" id="popup-{{ item.id }}">
                                <p>{{ item.ip }}{% if geoip2 and geoip2.country.isoCode%} <img src="{{ asset('bundles/wapinet/images/countries/' ~ geoip2.country.isoCode|lower ~ '.png') }}" alt="{{ geoip2.country.names['ru'] }}" />{% endif %}<br />{{ item.browser }}</p>
                            </div>
                        {% endif %}
                        </span>
                    {% endblock fos_comment_comment_metas_authorline %}

                    <div class="long-description">{{ item.message|wapinet_bbcode_parse }}</div>
                </li>
            {% else %}
                <li>Сообщений нет.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="pagerfanta">
        {{ pagerfanta(pagerfanta) }}
    </div>

{% endblock %}
