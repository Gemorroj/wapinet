{% set format %}{% spaceless %}
    {% if file.isM4v or file.is3gp or file.isWmv or file.isAvi %}
        m4v
    {% elseif file.isOgv %}
        ogv
    {% elseif file.isWebmv %}
        webmv
    {% elseif file.isFlv %}
        flv
    {% endif %}
{% endspaceless %}{% endset %}

{% set video %}{% spaceless %}
    {% if file.is3gp or file.isAvi or file.isWmv %}
        {{ vich_uploader_asset(file, 'file')|wapinet_video_to_mp4 }}
    {% else %}
        {{ vich_uploader_asset(file, 'file') }}
    {% endif %}
{% endspaceless %}{% endset %}

{% set screenshot = vich_uploader_asset(file, 'file')|wapinet_video_screenshot %}


$(document).on("pageshow", "#page", function () {
    {% if video %}
        // (Default width: "480px")
        // (Default height: "270px")

        var width = $(window).width();
        var space = 30;
        var defaultWidth = 480;
        width = (width > (defaultWidth + space)) ? defaultWidth : (width - space);

        $(":mobile-pagecontainer").find("#jquery_jplayer_1").jPlayer({
            "ready": function () {
                $(":mobile-pagecontainer").find(".jp-controls-holder").width(width - 40 + "px");
                $(":mobile-pagecontainer").find(".jp-controls").css({"margin-left": width - 250 + "px"});
                $(":mobile-pagecontainer").find("#jp_container_1").width(width + "px");
                $(this).jPlayer("setMedia", {
                    {% if screenshot is not null %}
                        "poster": "{{ screenshot }}",
                    {% endif %}
                    "{{ format }}": "{{ video }}"
                });
            },
            "supplied": "{{ format }}",
            "size": {"width": width + "px"},
            "swfPath": Jplayer.swfPath
        });
    {% else %}
        $(":mobile-pagecontainer").find("#jp_container_1").hide();
    {% endif %}
});
